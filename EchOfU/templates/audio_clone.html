<!DOCTYPE html>
<html lang="zh" class="futuristic-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é¢‘å…‹éš† | SYNCTALK AI</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">

    <!-- JavaScriptæ¨¡å— -->
    <script src="{{ url_for('static', filename='js/modules/theme-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/audio-manager.js') }}"></script>

    <style>
        /* åªä¿ç•™é¡µé¢ç‰¹æœ‰çš„æ ·å¼ */
        .progress-section {
            margin-top: var(--space-4);
            display: none;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-2);
            font-size: 0.875rem;
        }

        .progress-status {
            color: var(--neon-blue);
        }

        .status-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-3);
            margin-top: var(--space-4);
        }

        .status-card {
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            border-left: 3px solid var(--neon-blue);
        }

        .audio-element {
            width: 100%;
            border-radius: var(--radius-md);
            background: var(--surface-secondary);
            border: 1px solid rgba(0, 243, 255, 0.2);
            position: relative;
            z-index: 1;
        }

        .button-row {
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }

        .button-row .action-btn:first-child {
            flex: 2;
            font-size: 1rem;
        }

        .button-row .action-btn:last-child {
            flex: 1;
            font-size: 0.875rem;
        }

      </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="neon-navbar">
        <a href="/" class="nav-brand">
            <span>SYNCTALK</span>
        </a>
        <ul class="nav-menu">
            <li><a href="/model_training" class="nav-link">è®­ç»ƒæ¨¡å‹</a></li>
            <li><a href="/video_generation" class="nav-link">è§†é¢‘ç”Ÿæˆ</a></li>
            <li><a href="/audio_clone" class="nav-link active">éŸ³é¢‘å…‹éš†</a></li>
            <li><a href="/chat_system" class="nav-link">äººæœºå¯¹è¯</a></li>
        </ul>
        <!-- ä¸»é¢˜åˆ‡æ¢å™¨ -->
        <button class="theme-toggle navbar-theme-toggle" data-theme-toggle aria-label="åˆ‡æ¢ä¸»é¢˜">
            <span class="theme-icon sun">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.24M15.54 15.54l4.24 4.24M1 12h6M17 12h6M4.22 19.78l4.24-4.24M15.54 8.46l4.24-4.24" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </span>
            <span class="theme-icon moon">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2"/>
                </svg>
            </span>
            <span class="theme-tooltip">åˆ‡æ¢ä¸»é¢˜</span>
        </button>
    </nav>

    <div class="page-container">
        <div class="header-section">
            <h1 class="page-title">éŸ³é¢‘å…‹éš†</h1>
            <p class="page-subtitle">åŸºäºå‚è€ƒéŸ³é¢‘è¿›è¡Œé«˜è´¨é‡è¯­éŸ³å…‹éš†ç³»ç»Ÿ</p>
        </div>

        <div class="main-grid">
            <!-- éŸ³é¢‘æ’­æ”¾åŒºåŸŸ -->
            <div class="preview-wrapper">
                <!-- åŸéŸ³é¢‘æ’­æ”¾å™¨ -->
                <div class="preview-container" id="originalAudioPlayer">
                    <div class="preview-placeholder">
                        <h3>åŸéŸ³é¢‘æ’­æ”¾å™¨</h3>
                        <p>è¯·è¾“å…¥éŸ³é¢‘è·¯å¾„åç‚¹å‡»åŠ è½½</p>
                    </div>
                </div>

                <!-- ç”ŸæˆéŸ³é¢‘æ’­æ”¾å™¨ -->
                <div class="preview-container" id="clonedAudioPlayer">
                    <div class="preview-placeholder">
                        <h3>ç”ŸæˆéŸ³é¢‘æ’­æ”¾å™¨</h3>
                        <p>ç‰¹å¾æå–æˆåŠŸåï¼Œå¯ç”Ÿæˆæ–°éŸ³é¢‘åœ¨æ­¤æ˜¾ç¤º</p>
                    </div>
                </div>

                <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div class="status-indicators">
                    <div class="status-card">
                        <div class="indicator-label">å…‹éš†çŠ¶æ€</div>
                        <div class="indicator-value" id="cloneStatus">å‡†å¤‡å°±ç»ª</div>
                    </div>
                    <div class="status-card">
                        <div class="indicator-label">é¢„ä¼°æ—¶é—´</div>
                        <div class="indicator-value" id="estimatedTime">5-15 ç§’</div>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-panel floating-card">
                <form id="audioCloneForm">
                    <!-- éŸ³é¢‘å…‹éš†è®¾ç½® -->
                    <div class="control-group">
                        <div class="control-title">
                            <span>éŸ³é¢‘å…‹éš†è®¾ç½®</span>
                        </div>
                        <div class="control-grid">
                            <div>
                                <label class="indicator-label">ä¸Šä¼ å‚è€ƒéŸ³é¢‘</label>
                                <div style="display: flex; gap: var(--space-2); align-items: center;">
                                    <input type="file" class="neon-input" id="audioFileInput"
                                           accept=".wav,.mp3,.m4a,.flac,.ogg" style="flex: 1;">
                                    <button type="button" class="neon-btn neon-btn-primary" id="uploadAudioBtn" disabled>
                                        ä¸Šä¼ éŸ³é¢‘
                                    </button>
                                </div>
                                <div id="uploadStatus" style="margin-top: var(--space-2); color: var(--text-secondary); font-size: 0.875rem;"></div>
                            </div>

                            <div>
                                <label class="indicator-label">é€‰æ‹©å‚è€ƒéŸ³é¢‘</label>
                                <div style="display: flex; gap: var(--space-2); align-items: stretch;">
                                    <select class="neon-input" name="original_audio_path" id="originalAudioPath" style="flex: 1;">
                                        <option value="">è¯·é€‰æ‹©å‚è€ƒéŸ³é¢‘</option>
                                    </select>
                                    <button type="button" class="neon-btn neon-btn-sm" id="refreshRefAudioBtn" title="åˆ·æ–°å‚è€ƒéŸ³é¢‘åˆ—è¡¨">
                                        åˆ·æ–°
                                    </button>
                                </div>
                                <small style="color: var(--text-secondary); font-size: 0.875rem; margin-top: var(--space-1); display: block;">
                                    é€‰æ‹©å·²æœ‰çš„å‚è€ƒéŸ³é¢‘è¿›è¡Œå…‹éš†
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="action-section">
                        <button type="button" class="neon-btn neon-btn-glow action-btn" id="loadAudioBtn">
                            åŠ è½½åŸéŸ³é¢‘
                        </button>
                    </div>

                    <div class="section-divider"></div>

                    <!-- å…‹éš†æ“ä½œ -->
                    <div class="control-group">
                        <div class="control-title">
                            <span>å…‹éš†æ“ä½œ</span>
                        </div>
                        <div class="control-grid">
                            <div>
                                <label class="indicator-label">ç›®æ ‡éŸ³é¢‘ç¼–å·</label>
                                <input type="text" class="neon-input"
                                       placeholder="è¾“å…¥ç›®æ ‡éŸ³é¢‘ç¼–å·"
                                       name="target_audio_id" id="targetAudioId">
                            </div>
                        </div>
                    </div>

                    <div class="action-section">
                        <button type="button" class="neon-btn neon-btn-glow action-btn" id="cloneAudioBtn">
                            å¼€å§‹å…‹éš†
                        </button>

                        <div class="progress-section" id="cloneProgressSection">
                            <div class="progress-info">
                                <span class="progress-status" id="cloneProgressStatus">å…‹éš†ä¸­...</span>
                                <span id="cloneProgressPercent">0%</span>
                            </div>
                            <div class="neon-progress">
                                <div class="neon-progress-bar" id="cloneProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <!-- æ–‡æœ¬ç”Ÿæˆ -->
                    <div class="control-group">
                        <div class="control-title">
                            <span>æ–‡æœ¬ç”Ÿæˆ</span>
                        </div>
                        <div class="control-grid">
                            <div>
                                <label class="indicator-label">å…‹éš†éŸ³é¢‘ç¼–å·</label>
                                <div style="display: flex; gap: var(--space-2); align-items: stretch;">
                                    <select class="neon-input" name="gen_audio_id" id="genAudioId" style="flex: 1;">
                                        <option value="">è¯·é€‰æ‹©å…‹éš†éŸ³é¢‘</option>
                                        <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptä»åç«¯åŠ è½½ -->
                                    </select>
                                    <button type="button" class="neon-btn neon-btn-sm" id="refreshGenAudioBtn" title="åˆ·æ–°å…‹éš†éŸ³é¢‘åˆ—è¡¨">
                                        åˆ·æ–°
                                    </button>
                                </div>
                                <small style="color: var(--text-secondary); font-size: 0.875rem; margin-top: var(--space-1); display: block;">
                                    é€‰æ‹©å·²å…‹éš†çš„éŸ³é¢‘ç¼–å·
                                </small>
                            </div>

                            <div>
                                <label class="indicator-label">ç”Ÿæˆæ–‡æœ¬</label>
                                <textarea
                                    class="text-input-area"
                                    placeholder="è¾“å…¥éœ€è¦ç”Ÿæˆçš„æ–‡æœ¬å†…å®¹..."
                                    name="generate_text" id="generateText"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="action-section">
                        <button type="button" class="neon-btn neon-btn-glow action-btn" id="generateAudioBtn">
                            ç”ŸæˆéŸ³é¢‘
                        </button>

                        <div class="progress-section" id="generateProgressSection">
                            <div class="progress-info">
                                <span class="progress-status" id="generateProgressStatus">ç”Ÿæˆä¸­...</span>
                                <span id="generateProgressPercent">0%</span>
                            </div>
                            <div class="neon-progress">
                                <div class="neon-progress-bar" id="generateProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function getCloneStatusText(progress) {
            if (progress < 20) return 'åˆ†æåŸéŸ³é¢‘...';
            if (progress < 40) return 'æå–è¯­éŸ³ç‰¹å¾...';
            if (progress < 60) return 'ç”Ÿæˆå…‹éš†éŸ³é¢‘...';
            if (progress < 80) return 'éŸ³é¢‘åå¤„ç†...';
            return 'å®Œæˆå¤„ç†...';
        }

        function getGenerateStatusText(progress) {
            if (progress < 25) return 'æ–‡æœ¬åˆ†æ...';
            if (progress < 50) return 'è¯­éŸ³åˆæˆ...';
            if (progress < 75) return 'éŸ³é¢‘å¤„ç†...';
            return 'å®Œæˆå¤„ç†...';
        }

        // æ–‡ä»¶é€‰æ‹©ç›¸å…³å˜é‡
        let selectedFile = null;

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        document.getElementById('audioFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const uploadBtn = document.getElementById('uploadAudioBtn');
            const uploadStatus = document.getElementById('uploadStatus');

            if (file) {
                selectedFile = file;
                uploadBtn.disabled = false;
                uploadBtn.textContent = `ä¸Šä¼  ${file.name}`;
                uploadStatus.textContent = `å·²é€‰æ‹©: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`;
                uploadStatus.style.color = 'var(--neon-green)';
            } else {
                selectedFile = null;
                uploadBtn.disabled = true;
                uploadBtn.textContent = 'ä¸Šä¼ éŸ³é¢‘';
                uploadStatus.textContent = '';
            }
        });

        // ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
        document.getElementById('uploadAudioBtn').addEventListener('click', async function() {
            if (!selectedFile) {
                alert('è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„éŸ³é¢‘æ–‡ä»¶');
                return;
            }

            const btn = this;
            const uploadStatus = document.getElementById('uploadStatus');

            btn.disabled = true;
            btn.textContent = 'ä¸Šä¼ ä¸­...';
            uploadStatus.textContent = 'æ­£åœ¨ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶...';

            try {
                const formData = new FormData();
                formData.append('audio', selectedFile);

                const response = await fetch('/api/upload-reference-audio', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    uploadStatus.textContent = `ä¸Šä¼ æˆåŠŸ: ${result.filename}`;
                    uploadStatus.style.color = 'var(--neon-green)';

                    // åˆ·æ–°å‚è€ƒéŸ³é¢‘åˆ—è¡¨
                    await loadReferenceAudios();

                    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    document.getElementById('audioFileInput').value = '';
                    selectedFile = null;
                    btn.disabled = true;
                    btn.textContent = 'ä¸Šä¼ éŸ³é¢‘';

                } else {
                    uploadStatus.textContent = `ä¸Šä¼ å¤±è´¥: ${result.message}`;
                    uploadStatus.style.color = 'var(--neon-red)';
                }
            } catch (error) {
                console.error('ä¸Šä¼ éŸ³é¢‘å¤±è´¥:', error);
                uploadStatus.textContent = 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                uploadStatus.style.color = 'var(--neon-red)';
            } finally {
                if (btn.textContent === 'ä¸Šä¼ ä¸­...') {
                    btn.disabled = false;
                    btn.textContent = 'ä¸Šä¼ éŸ³é¢‘';
                }
            }
        });

        // åŠ è½½å‚è€ƒéŸ³é¢‘åˆ—è¡¨
        async function loadReferenceAudios() {
            try {
                const response = await fetch('/api/reference-audios');
                const data = await response.json();

                if (data.status === 'success') {
                    const select = document.getElementById('originalAudioPath');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©å‚è€ƒéŸ³é¢‘</option>';

                    data.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.relative_path;
                        option.textContent = `${file.filename} (${file.size_mb}MB)`;
                        option.title = `åˆ›å»ºæ—¶é—´: ${file.created_time}`;
                        select.appendChild(option);
                    });

                    console.log(`[UI] åŠ è½½äº† ${data.files.length} ä¸ªå‚è€ƒéŸ³é¢‘`);
                } else {
                    console.error('åŠ è½½å‚è€ƒéŸ³é¢‘åˆ—è¡¨å¤±è´¥:', data.message);
                }
            } catch (error) {
                console.error('åŠ è½½å‚è€ƒéŸ³é¢‘åˆ—è¡¨å‡ºé”™:', error);
            }
        }

        // åˆ·æ–°å‚è€ƒéŸ³é¢‘åˆ—è¡¨æŒ‰é’®äº‹ä»¶
        document.getElementById('refreshRefAudioBtn').addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = 'åˆ·æ–°ä¸­...';
            btn.style.color = 'var(--neon-blue)';

            try {
                await loadReferenceAudios();

                btn.innerHTML = 'å·²åˆ·æ–°';
                btn.style.color = 'var(--neon-green)';

                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.style.color = '';
                }, 2000);
            } catch (error) {
                console.error('åˆ·æ–°å‚è€ƒéŸ³é¢‘åˆ—è¡¨å¤±è´¥:', error);

                btn.innerHTML = 'åˆ·æ–°å¤±è´¥';
                btn.style.color = 'var(--neon-red)';

                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.style.color = '';
                }, 2000);
            }
        });

        // åŠ è½½åŸéŸ³é¢‘
        document.getElementById('loadAudioBtn').addEventListener('click', function() {
            const audioPath = document.getElementById('originalAudioPath').value.trim();
            const playerContainer = document.getElementById('originalAudioPlayer');

            if (!audioPath) {
                alert('è¯·é€‰æ‹©åŸéŸ³é¢‘');
                return;
            }

            // åˆ›å»ºéŸ³é¢‘æ’­æ”¾å™¨
            playerContainer.innerHTML = `
                <audio controls class="audio-element" id="originalAudioElement">
                    <source src="/${audioPath}" type="audio/wav">
                    <source src="/${audioPath}" type="audio/mpeg">
                    <source src="/${audioPath}" type="audio/ogg">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                </audio>
                <div style="text-align: center; margin-top: var(--space-2); color: var(--text-secondary);">
                    <small>ğŸ“ ${audioPath}</small>
                </div>
            `;

            // å°è¯•åŠ è½½éŸ³é¢‘
            const audio = document.getElementById('originalAudioElement');
            audio.load();

            audio.addEventListener('error', function() {
                playerContainer.innerHTML = `
                    <div class="preview-placeholder">
                        <h3>éŸ³é¢‘åŠ è½½å¤±è´¥</h3>
                        <p>è¯·æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®</p>
                        <small style="color: var(--text-secondary);">${audioPath}</small>
                    </div>
                `;
            });

            audio.addEventListener('loadeddata', function() {
                const cloneStatus = document.getElementById('cloneStatus');
                cloneStatus.textContent = 'éŸ³é¢‘å·²åŠ è½½';
                cloneStatus.style.color = 'var(--neon-green)';
            });
        });

        // å…‹éš†éŸ³é¢‘
        document.getElementById('cloneAudioBtn').addEventListener('click', async function() {
            const originalPath = document.getElementById('originalAudioPath').value.trim();
            const targetAudioId = document.getElementById('targetAudioId').value.trim();

            if (!originalPath || !targetAudioId) {
                alert('è¯·å¡«å†™åŸéŸ³é¢‘è·¯å¾„å’Œç›®æ ‡éŸ³é¢‘ç¼–å·');
                return;
            }

            const btn = this;
            const progressSection = document.getElementById('cloneProgressSection');
            const progressBar = document.getElementById('cloneProgressBar');
            const progressPercent = document.getElementById('cloneProgressPercent');
            const progressStatus = document.getElementById('cloneProgressStatus');
            const cloneStatus = document.getElementById('cloneStatus');

            progressSection.style.display = 'block';
            btn.disabled = true;
            btn.innerHTML = 'å…‹éš†ä¸­...';
            cloneStatus.textContent = 'å…‹éš†ä¸­...';

            // æ¨¡æ‹Ÿè¿›åº¦
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = `${progress}%`;
                progressPercent.textContent = `${Math.round(progress)}%`;
                progressStatus.textContent = getCloneStatusText(progress);
                cloneStatus.textContent = getCloneStatusText(progress);
            }, 500);

            try {
                // è°ƒç”¨å®é™…çš„å…‹éš†æ¥å£
                const formData = new FormData();
                formData.append('original_audio_path', originalPath);
                formData.append('audio_id', targetAudioId); // ä½¿ç”¨ç›®æ ‡éŸ³é¢‘IDä½œä¸ºéŸ³é¢‘ID
                formData.append('target_audio_id', targetAudioId);
                formData.append('gen_audio_id', ''); // å…‹éš†é˜¶æ®µä¸ç”Ÿæˆæ–‡æœ¬
                formData.append('generate_text', ''); // å…‹éš†é˜¶æ®µä¸ç”Ÿæˆæ–‡æœ¬

                console.log('[éŸ³é¢‘å…‹éš†] å‘é€å…‹éš†è¯·æ±‚:', {
                    original_audio_path: originalPath,
                    audio_id: targetAudioId,
                    target_audio_id: targetAudioId
                });

                const response = await fetch('/audio_clone', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                console.log('[éŸ³é¢‘å…‹éš†] æœåŠ¡å™¨å“åº”:', result);

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressPercent.textContent = '100%';

                if (result.status === 'success') {
                    progressStatus.textContent = 'ç‰¹å¾æå–å®Œæˆ';
                    cloneStatus.textContent = 'ç‰¹å¾æå–å®Œæˆ';
                    cloneStatus.style.color = 'var(--neon-green)';

                    // æ˜¾ç¤ºç‰¹å¾æå–æˆåŠŸä¿¡æ¯ï¼ˆä¸æ˜¾ç¤ºéŸ³é¢‘æ’­æ”¾å™¨ï¼Œå› ä¸ºè¿™åªæ˜¯ç‰¹å¾æå–ï¼‰
                    const clonedContainer = document.getElementById('clonedAudioPlayer');

                    clonedContainer.innerHTML = `
                        <div style="text-align: center; padding: var(--space-4); background: var(--surface-secondary); border-radius: var(--radius-lg); border: 1px solid var(--neon-green);">
                            <div style="font-size: 2rem; color: var(--neon-green); margin-bottom: var(--space-2);">âœ…</div>
                            <div style="color: var(--text-primary); font-weight: 600; margin-bottom: var(--space-2);">ç‰¹å¾æå–æˆåŠŸ!</div>
                            <div style="color: var(--text-secondary); font-size: 0.875rem;">
                                <div> è¯´è¯äººID: <strong>${targetAudioId}</strong></div>
                                <div> æå–æ—¶é—´: <strong>${new Date().toLocaleString()}</strong></div>
                                <div> ç°åœ¨å¯ä»¥ä½¿ç”¨æ­¤è¯´è¯äººç‰¹å¾ç”Ÿæˆæ–°çš„éŸ³é¢‘</div>
                            </div>
                        </div>
                    `;

                    // åˆ·æ–°éŸ³é¢‘åˆ—è¡¨ï¼Œä½¿æ–°å…‹éš†çš„éŸ³é¢‘å‡ºç°åœ¨é€‰æ‹©æ¡†ä¸­
                    setTimeout(() => {
                        refreshAudioData();
                    }, 1000);

                } else {
                    progressStatus.textContent = 'å…‹éš†å¤±è´¥';
                    cloneStatus.textContent = 'å…‹éš†å¤±è´¥';
                    cloneStatus.style.color = 'var(--neon-red)';
                    alert(`å…‹éš†å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                }

            } catch (error) {
                console.error('[éŸ³é¢‘å…‹éš†] è¯·æ±‚å¤±è´¥:', error);
                clearInterval(progressInterval);
                progressStatus.textContent = 'å…‹éš†å¤±è´¥';
                cloneStatus.textContent = 'å…‹éš†å¤±è´¥';
                cloneStatus.style.color = 'var(--neon-red)';
                alert('å…‹éš†è¯·æ±‚å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'å¼€å§‹å…‹éš†';
                setTimeout(() => { progressSection.style.display = 'none'; }, 2000);
            }
        });

        // åˆå§‹åŒ–éŸ³é¢‘é€‰æ‹©æ¡†
        async function initializeAudioSelects() {
            try {
                // åˆå§‹åŒ–ç”ŸæˆéŸ³é¢‘é€‰æ‹©æ¡† - å¼ºåˆ¶åˆ·æ–°ä»¥è·å–æœ€æ–°æ•°æ®
                const genAudioSelect = document.getElementById('genAudioId');
                if (genAudioSelect) {
                    await window.AudioUtils.fillAudioSelect('#genAudioId', 'è¯·é€‰æ‹©å…‹éš†éŸ³é¢‘', '', true);
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–éŸ³é¢‘é€‰æ‹©æ¡†å¤±è´¥:', error);
            }
        }

        // åˆ·æ–°å…‹éš†éŸ³é¢‘åˆ—è¡¨æŒ‰é’®äº‹ä»¶
        document.getElementById('refreshGenAudioBtn').addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = 'åˆ·æ–°ä¸­...';
            btn.style.color = 'var(--neon-blue)';

            try {
                await loadClonedAudios();

                btn.innerHTML = 'å·²åˆ·æ–°';
                btn.style.color = 'var(--neon-green)';

                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.style.color = '';
                }, 2000);
            } catch (error) {
                console.error('åˆ·æ–°å…‹éš†éŸ³é¢‘åˆ—è¡¨å¤±è´¥:', error);

                btn.innerHTML = 'åˆ·æ–°å¤±è´¥';
                btn.style.color = 'var(--neon-red)';

                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.style.color = '';
                }, 2000);
            }
        });

        // åŠ è½½å…‹éš†éŸ³é¢‘åˆ—è¡¨
        async function loadClonedAudios() {
            try {
                const response = await fetch('/api/cloned-audios');
                const data = await response.json();

                if (data.status === 'success') {
                    const select = document.getElementById('genAudioId');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©å…‹éš†éŸ³é¢‘</option>';

                    data.audios.forEach(audio => {
                        const option = document.createElement('option');
                        option.value = audio.id;
                        option.textContent = `${audio.id} - ${audio.name} (${audio.created_at})`;
                        option.title = `çŠ¶æ€: ${audio.status}\nåˆ›å»ºæ—¶é—´: ${audio.created_at}\nå‚è€ƒéŸ³é¢‘: ${audio.reference_audio}`;
                        select.appendChild(option);
                    });

                    console.log(`[UI] åŠ è½½äº† ${data.audios.length} ä¸ªå…‹éš†éŸ³é¢‘`);
                } else {
                    console.error('åŠ è½½å…‹éš†éŸ³é¢‘åˆ—è¡¨å¤±è´¥:', data.message);
                }
            } catch (error) {
                console.error('åŠ è½½å…‹éš†éŸ³é¢‘åˆ—è¡¨å‡ºé”™:', error);
            }
        }

        // åˆ·æ–°éŸ³é¢‘æ•°æ®ï¼ˆç®€åŒ–ç‰ˆï¼Œä¸å†éœ€è¦æŒ‰é’®åé¦ˆï¼‰
        async function refreshAudioData() {
            try {
                console.log('æ­£åœ¨åˆ·æ–°éŸ³é¢‘æ•°æ®...');
                await window.AudioUtils.refreshAllAudioSelects();
                console.log('éŸ³é¢‘æ•°æ®åˆ·æ–°å®Œæˆ');
            } catch (error) {
                console.error('åˆ·æ–°éŸ³é¢‘æ•°æ®å¤±è´¥:', error);
            }
        }

        // ç”ŸæˆéŸ³é¢‘
        document.getElementById('generateAudioBtn').addEventListener('click', async function() {
            const genAudioId = document.getElementById('genAudioId').value.trim();
            const generateText = document.getElementById('generateText').value.trim();

            if (!genAudioId || !generateText) {
                alert('è¯·å¡«å†™éŸ³é¢‘ç¼–å·å’Œç”Ÿæˆæ–‡æœ¬');
                return;
            }

            const btn = this;
            const progressSection = document.getElementById('generateProgressSection');
            const progressBar = document.getElementById('generateProgressBar');
            const progressPercent = document.getElementById('generateProgressPercent');
            const progressStatus = document.getElementById('generateProgressStatus');

            progressSection.style.display = 'block';
            btn.disabled = true;
            btn.innerHTML = 'ç”Ÿæˆä¸­...';

            // æ¨¡æ‹Ÿè¿›åº¦
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = `${progress}%`;
                progressPercent.textContent = `${Math.round(progress)}%`;
                progressStatus.textContent = getGenerateStatusText(progress);
            }, 500);

            try {
                // è°ƒç”¨å®é™…çš„ç”Ÿæˆæ¥å£
                const formData = new FormData();
                formData.append('original_audio_path', ''); // ç”Ÿæˆé˜¶æ®µä¸éœ€è¦åŸéŸ³é¢‘
                formData.append('audio_id', genAudioId);
                formData.append('target_audio_id', genAudioId);
                formData.append('gen_audio_id', genAudioId);
                formData.append('generate_text', generateText);

                console.log('[éŸ³é¢‘ç”Ÿæˆ] å‘é€ç”Ÿæˆè¯·æ±‚:', {
                    audio_id: genAudioId,
                    generate_text: generateText
                });

                const response = await fetch('/audio_clone', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                console.log('[éŸ³é¢‘ç”Ÿæˆ] æœåŠ¡å™¨å“åº”:', result);

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressPercent.textContent = '100%';

                if (result.status === 'success') {
                    progressStatus.textContent = 'ç”Ÿæˆå®Œæˆ';

                    if (result.cloned_audio_path) {
                        // æ˜¾ç¤ºç”Ÿæˆçš„éŸ³é¢‘
                        const generatedContainer = document.getElementById('clonedAudioPlayer');
                        const audioPath = result.cloned_audio_path;

                        generatedContainer.innerHTML = `
                            <audio controls class="audio-element" autoplay>
                                <source src="/${audioPath}" type="audio/wav">
                                <source src="/${audioPath.replace('.wav', '.mp3')}" type="audio/mpeg">
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                            </audio>
                            <div style="text-align: center; margin-top: var(--space-2); color: var(--neon-green);">
                                <small> ç”Ÿæˆå®Œæˆ - éŸ³é¢‘: ${genAudioId}</small>
                                <br><small> æ–‡ä»¶è·¯å¾„: ${audioPath}</small>
                                <br><small> æ–‡æœ¬å†…å®¹: "${generateText}"</small>
                            </div>
                        `;

                        // æ¸…ç©ºæ–‡æœ¬è¾“å…¥æ¡†
                        document.getElementById('generateText').value = '';
                    }

                    alert(`éŸ³é¢‘ç”Ÿæˆå®Œæˆï¼\néŸ³é¢‘ç¼–å·: ${genAudioId}\næ–‡æœ¬å†…å®¹: ${generateText}`);

                } else {
                    progressStatus.textContent = 'ç”Ÿæˆå¤±è´¥';
                    alert(`ç”Ÿæˆå¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                }

            } catch (error) {
                console.error('[éŸ³é¢‘ç”Ÿæˆ] è¯·æ±‚å¤±è´¥:', error);
                clearInterval(progressInterval);
                progressStatus.textContent = 'ç”Ÿæˆå¤±è´¥';
                alert('éŸ³é¢‘ç”Ÿæˆè¯·æ±‚å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ç”ŸæˆéŸ³é¢‘';
                setTimeout(() => { progressSection.style.display = 'none'; }, 2000);
            }
        });

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeAudioSelects();
            // åŒæ—¶åŠ è½½å‚è€ƒéŸ³é¢‘åˆ—è¡¨å’Œå…‹éš†éŸ³é¢‘åˆ—è¡¨
            loadReferenceAudios();
            loadClonedAudios();
        });
    </script>
</body>
</html>