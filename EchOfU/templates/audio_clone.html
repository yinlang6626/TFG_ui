<!DOCTYPE html>
<html lang="zh" class="futuristic-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³é¢‘å…‹éš† | SYNCTALK AI</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">

    <style>
        /* åªä¿ç•™é¡µé¢ç‰¹æœ‰çš„æ ·å¼ */
        .progress-section {
            margin-top: var(--space-4);
            display: none;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-2);
            font-size: 0.875rem;
        }

        .progress-status {
            color: var(--neon-blue);
        }

        .status-indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-3);
            margin-top: var(--space-4);
        }

        .status-card {
            background: var(--surface-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            border-left: 3px solid var(--neon-blue);
        }

        .audio-element {
            width: 100%;
            border-radius: var(--radius-md);
            background: var(--surface-secondary);
            border: 1px solid rgba(0, 243, 255, 0.2);
            position: relative;
            z-index: 1;
        }

        .button-row {
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }

        .button-row .action-btn:first-child {
            flex: 2;
            font-size: 1rem;
        }

        .button-row .action-btn:last-child {
            flex: 1;
            font-size: 0.875rem;
        }

      </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="neon-navbar">
        <a href="/" class="nav-brand">
            <span>SYNCTALK</span>
        </a>
        <ul class="nav-menu">
            <li><a href="/model_training" class="nav-link">è®­ç»ƒæ¨¡å‹</a></li>
            <li><a href="/video_generation" class="nav-link">è§†é¢‘ç”Ÿæˆ</a></li>
            <li><a href="/audio_clone" class="nav-link active">éŸ³é¢‘å…‹éš†</a></li>
            <li><a href="/chat_system" class="nav-link">äººæœºå¯¹è¯</a></li>
        </ul>
    </nav>

    <div class="page-container">
        <div class="header-section">
            <h1 class="page-title">éŸ³é¢‘å…‹éš†</h1>
            <p class="page-subtitle">åŸºäºå‚è€ƒéŸ³é¢‘è¿›è¡Œé«˜è´¨é‡è¯­éŸ³å…‹éš†ç³»ç»Ÿ</p>
        </div>

        <div class="main-grid">
            <!-- éŸ³é¢‘æ’­æ”¾åŒºåŸŸ -->
            <div class="preview-wrapper">
                <!-- åŸéŸ³é¢‘æ’­æ”¾å™¨ -->
                <div class="preview-container" id="originalAudioPlayer">
                    <div class="preview-placeholder">
                        <h3>åŸéŸ³é¢‘æ’­æ”¾å™¨</h3>
                        <p>è¯·è¾“å…¥éŸ³é¢‘è·¯å¾„åç‚¹å‡»åŠ è½½</p>
                    </div>
                </div>

                <!-- å…‹éš†éŸ³é¢‘æ’­æ”¾å™¨ -->
                <div class="preview-container" id="clonedAudioPlayer">
                    <div class="preview-placeholder">
                        <h3>å…‹éš†éŸ³é¢‘æ’­æ”¾å™¨</h3>
                        <p>å…‹éš†å®Œæˆåå°†åœ¨æ­¤æ˜¾ç¤º</p>
                    </div>
                </div>

                <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div class="status-indicators">
                    <div class="status-card">
                        <div class="indicator-label">å…‹éš†çŠ¶æ€</div>
                        <div class="indicator-value" id="cloneStatus">å‡†å¤‡å°±ç»ª</div>
                    </div>
                    <div class="status-card">
                        <div class="indicator-label">é¢„ä¼°æ—¶é—´</div>
                        <div class="indicator-value" id="estimatedTime">5-15 ç§’</div>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-panel floating-card">
                <form id="audioCloneForm">
                    <!-- éŸ³é¢‘å…‹éš†è®¾ç½® -->
                    <div class="control-group">
                        <div class="control-title">
                            <span>éŸ³é¢‘å…‹éš†è®¾ç½®</span>
                        </div>
                        <div class="control-grid">
                            <div>
                                <label class="indicator-label">åŸéŸ³é¢‘è·¯å¾„</label>
                                <input type="text" class="neon-input"
                                       placeholder="è¾“å…¥åŸéŸ³é¢‘ç›¸å¯¹è·¯å¾„"
                                       name="original_audio_path" id="originalAudioPath">
                                <small style="color: var(--text-secondary); font-size: 0.875rem; margin-top: var(--space-1); display: block;">
                                    ä¾‹å¦‚: static/voices/example.wav
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="action-section">
                        <button type="button" class="neon-btn neon-btn-glow action-btn" id="loadAudioBtn">
                            åŠ è½½åŸéŸ³é¢‘
                        </button>
                    </div>

                    <div class="section-divider"></div>

                    <!-- å…‹éš†æ“ä½œ -->
                    <div class="control-group">
                        <div class="control-title">
                            <span>å…‹éš†æ“ä½œ</span>
                        </div>
                        <div class="control-grid">
                            <div>
                                <label class="indicator-label">ç›®æ ‡éŸ³é¢‘ç¼–å·</label>
                                <input type="text" class="neon-input"
                                       placeholder="è¾“å…¥ç›®æ ‡éŸ³é¢‘ç¼–å·"
                                       name="target_audio_id" id="targetAudioId">
                            </div>
                        </div>
                    </div>

                    <div class="action-section">
                        <button type="button" class="neon-btn neon-btn-glow action-btn" id="cloneAudioBtn">
                            å¼€å§‹å…‹éš†
                        </button>

                        <div class="progress-section" id="cloneProgressSection">
                            <div class="progress-info">
                                <span class="progress-status" id="cloneProgressStatus">å…‹éš†ä¸­...</span>
                                <span id="cloneProgressPercent">0%</span>
                            </div>
                            <div class="neon-progress">
                                <div class="neon-progress-bar" id="cloneProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <!-- æ–‡æœ¬ç”Ÿæˆ -->
                    <div class="control-group">
                        <div class="control-title">
                            <span>æ–‡æœ¬ç”Ÿæˆ</span>
                        </div>
                        <div class="control-grid">
                            <div>
                                <label class="indicator-label">å…‹éš†éŸ³é¢‘ç¼–å·</label>
                                <select class="neon-input" name="gen_audio_id" id="genAudioId">
                                    <option value="">è¯·é€‰æ‹©å…‹éš†éŸ³é¢‘</option>
                                    <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptä»åç«¯åŠ è½½ -->
                                </select>
                                <small style="color: var(--text-secondary); font-size: 0.875rem; margin-top: var(--space-1); display: block;">
                                    é€‰æ‹©å·²å…‹éš†çš„éŸ³é¢‘ç¼–å·
                                </small>
                            </div>

                            <div>
                                <label class="indicator-label">ç”Ÿæˆæ–‡æœ¬</label>
                                <textarea
                                    class="text-input-area"
                                    placeholder="è¾“å…¥éœ€è¦ç”Ÿæˆçš„æ–‡æœ¬å†…å®¹..."
                                    name="generate_text" id="generateText"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="action-section">
                        <div class="button-row">
                            <button type="button" class="neon-btn neon-btn-glow action-btn" id="generateAudioBtn">
                                ç”ŸæˆéŸ³é¢‘
                            </button>

                            <button type="button" class="neon-btn action-btn" id="refreshBtn">
                                åˆ·æ–°éŸ³é¢‘åˆ—è¡¨
                            </button>
                        </div>

                        <div class="progress-section" id="generateProgressSection">
                            <div class="progress-info">
                                <span class="progress-status" id="generateProgressStatus">ç”Ÿæˆä¸­...</span>
                                <span id="generateProgressPercent">0%</span>
                            </div>
                            <div class="neon-progress">
                                <div class="neon-progress-bar" id="generateProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function getCloneStatusText(progress) {
            if (progress < 20) return 'åˆ†æåŸéŸ³é¢‘...';
            if (progress < 40) return 'æå–è¯­éŸ³ç‰¹å¾...';
            if (progress < 60) return 'ç”Ÿæˆå…‹éš†éŸ³é¢‘...';
            if (progress < 80) return 'éŸ³é¢‘åå¤„ç†...';
            return 'å®Œæˆå¤„ç†...';
        }

        function getGenerateStatusText(progress) {
            if (progress < 25) return 'æ–‡æœ¬åˆ†æ...';
            if (progress < 50) return 'è¯­éŸ³åˆæˆ...';
            if (progress < 75) return 'éŸ³é¢‘å¤„ç†...';
            return 'å®Œæˆå¤„ç†...';
        }

        // åŠ è½½åŸéŸ³é¢‘
        document.getElementById('loadAudioBtn').addEventListener('click', function() {
            const audioPath = document.getElementById('originalAudioPath').value.trim();
            const playerContainer = document.getElementById('originalAudioPlayer');

            if (!audioPath) {
                alert('è¯·è¾“å…¥åŸéŸ³é¢‘è·¯å¾„');
                return;
            }

            // åˆ›å»ºéŸ³é¢‘æ’­æ”¾å™¨
            playerContainer.innerHTML = `
                <audio controls class="audio-element" id="originalAudioElement">
                    <source src="/${audioPath}" type="audio/wav">
                    <source src="/${audioPath}" type="audio/mpeg">
                    <source src="/${audioPath}" type="audio/ogg">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                </audio>
                <div style="text-align: center; margin-top: var(--space-2); color: var(--text-secondary);">
                    <small>ğŸ“ ${audioPath}</small>
                </div>
            `;

            // å°è¯•åŠ è½½éŸ³é¢‘
            const audio = document.getElementById('originalAudioElement');
            audio.load();

            audio.addEventListener('error', function() {
                playerContainer.innerHTML = `
                    <div class="preview-placeholder">
                        <div class="preview-icon">âŒ</div>
                        <h3>éŸ³é¢‘åŠ è½½å¤±è´¥</h3>
                        <p>è¯·æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®</p>
                        <small style="color: var(--text-secondary);">${audioPath}</small>
                    </div>
                `;
            });

            audio.addEventListener('loadeddata', function() {
                const cloneStatus = document.getElementById('cloneStatus');
                cloneStatus.textContent = 'éŸ³é¢‘å·²åŠ è½½';
                cloneStatus.style.color = 'var(--neon-green)';
            });
        });

        // å…‹éš†éŸ³é¢‘
        document.getElementById('cloneAudioBtn').addEventListener('click', async function() {
            const originalPath = document.getElementById('originalAudioPath').value.trim();
            const targetAudioId = document.getElementById('targetAudioId').value.trim();

            if (!originalPath || !targetAudioId) {
                alert('è¯·å¡«å†™åŸéŸ³é¢‘è·¯å¾„å’Œç›®æ ‡éŸ³é¢‘ç¼–å·');
                return;
            }

            const btn = this;
            const progressSection = document.getElementById('cloneProgressSection');
            const progressBar = document.getElementById('cloneProgressBar');
            const progressPercent = document.getElementById('cloneProgressPercent');
            const progressStatus = document.getElementById('cloneProgressStatus');
            const cloneStatus = document.getElementById('cloneStatus');

            progressSection.style.display = 'block';
            btn.disabled = true;
            btn.innerHTML = 'å…‹éš†ä¸­...';
            cloneStatus.textContent = 'å…‹éš†ä¸­...';

            // æ¨¡æ‹Ÿè¿›åº¦
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = `${progress}%`;
                progressPercent.textContent = `${Math.round(progress)}%`;
                progressStatus.textContent = getCloneStatusText(progress);
                cloneStatus.textContent = getCloneStatusText(progress);
            }, 500);

            try {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„å…‹éš†æ¥å£
                // const formData = new FormData();
                // formData.append('original_path', originalPath);
                // formData.append('audio_id', audioId);
                // formData.append('target_id', targetAudioId);
                // const response = await fetch('/audio_clone', { method: 'POST', body: formData });
                // const result = await response.json();

                // æ¨¡æ‹Ÿå»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 3000));

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressPercent.textContent = '100%';
                progressStatus.textContent = 'å…‹éš†å®Œæˆ';
                cloneStatus.textContent = 'å…‹éš†å®Œæˆ';
                cloneStatus.style.color = 'var(--neon-green)';

                // æ˜¾ç¤ºå…‹éš†éŸ³é¢‘
                const clonedContainer = document.getElementById('clonedAudioPlayer');
                clonedContainer.innerHTML = `
                    <audio controls class="audio-element" autoplay>
                        <source src="/static/voices/cloned_${targetAudioId}.wav" type="audio/wav">
                        <source src="/static/voices/cloned_${targetAudioId}.mp3" type="audio/mpeg">
                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
                    </audio>
                    <div style="text-align: center; margin-top: var(--space-2); color: var(--neon-green);">
                        <small>âœ… å…‹éš†å®Œæˆ - ç›®æ ‡éŸ³é¢‘: ${targetAudioId}</small>
                    </div>
                `;

            } catch (error) {
                console.error('Error:', error);
                clearInterval(progressInterval);
                progressStatus.textContent = 'å…‹éš†å¤±è´¥';
                cloneStatus.textContent = 'å…‹éš†å¤±è´¥';
                cloneStatus.style.color = 'var(--neon-red)';
                alert('å…‹éš†å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'å¼€å§‹å…‹éš†';
                setTimeout(() => { progressSection.style.display = 'none'; }, 2000);
            }
        });

        // åˆå§‹åŒ–éŸ³é¢‘é€‰æ‹©æ¡†
        async function initializeAudioSelects() {
            try {
                // åˆå§‹åŒ–ç”ŸæˆéŸ³é¢‘é€‰æ‹©æ¡† - å¼ºåˆ¶åˆ·æ–°ä»¥è·å–æœ€æ–°æ•°æ®
                const genAudioSelect = document.getElementById('genAudioId');
                if (genAudioSelect) {
                    await window.AudioUtils.fillAudioSelect('#genAudioId', 'è¯·é€‰æ‹©å…‹éš†éŸ³é¢‘', '', true);
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–éŸ³é¢‘é€‰æ‹©æ¡†å¤±è´¥:', error);
            }
        }

        // å¼ºåˆ¶åˆ·æ–°éŸ³é¢‘æ•°æ®
        async function refreshAudioData() {
            try {
                console.log('æ­£åœ¨åˆ·æ–°éŸ³é¢‘æ•°æ®...');
                await window.AudioUtils.refreshAllAudioSelects();
                console.log('éŸ³é¢‘æ•°æ®åˆ·æ–°å®Œæˆ');

                // æ˜¾ç¤ºåˆ·æ–°æˆåŠŸæç¤º
                const btn = document.getElementById('refreshBtn');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'âœ… å·²åˆ·æ–°';
                    btn.style.color = 'var(--neon-green)';

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.color = '';
                    }, 2000);
                }
            } catch (error) {
                console.error('åˆ·æ–°éŸ³é¢‘æ•°æ®å¤±è´¥:', error);

                // æ˜¾ç¤ºåˆ·æ–°å¤±è´¥æç¤º
                const btn = document.getElementById('refreshBtn');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'âŒ åˆ·æ–°å¤±è´¥';
                    btn.style.color = 'var(--neon-red)';

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.color = '';
                    }, 2000);
                }
            }
        }

        // ç”ŸæˆéŸ³é¢‘
        document.getElementById('generateAudioBtn').addEventListener('click', async function() {
            const genAudioId = document.getElementById('genAudioId').value.trim();
            const generateText = document.getElementById('generateText').value.trim();

            if (!genAudioId || !generateText) {
                alert('è¯·å¡«å†™éŸ³é¢‘ç¼–å·å’Œç”Ÿæˆæ–‡æœ¬');
                return;
            }

            const btn = this;
            const progressSection = document.getElementById('generateProgressSection');
            const progressBar = document.getElementById('generateProgressBar');
            const progressPercent = document.getElementById('generateProgressPercent');
            const progressStatus = document.getElementById('generateProgressStatus');

            progressSection.style.display = 'block';
            btn.disabled = true;
            btn.innerHTML = 'ç”Ÿæˆä¸­...';

            // æ¨¡æ‹Ÿè¿›åº¦
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = `${progress}%`;
                progressPercent.textContent = `${Math.round(progress)}%`;
                progressStatus.textContent = getGenerateStatusText(progress);
            }, 500);

            try {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„ç”Ÿæˆæ¥å£
                // const formData = new FormData();
                // formData.append('audio_id', genAudioId);
                // formData.append('text', generateText);
                // const response = await fetch('/generate_audio', { method: 'POST', body: formData });
                // const result = await response.json();

                // æ¨¡æ‹Ÿå»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 4000));

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressPercent.textContent = '100%';
                progressStatus.textContent = 'ç”Ÿæˆå®Œæˆ';

                alert(`éŸ³é¢‘ç”Ÿæˆå®Œæˆï¼\néŸ³é¢‘ç¼–å·: ${genAudioId}\næ–‡æœ¬å†…å®¹: ${generateText}`);

            } catch (error) {
                console.error('Error:', error);
                clearInterval(progressInterval);
                progressStatus.textContent = 'ç”Ÿæˆå¤±è´¥';
                alert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ç”ŸæˆéŸ³é¢‘';
                setTimeout(() => { progressSection.style.display = 'none'; }, 2000);
            }
        });

        // åˆ·æ–°æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('refreshBtn').addEventListener('click', refreshAudioData);

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeAudioSelects();
        });
    </script>
</body>
</html>