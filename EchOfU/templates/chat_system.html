<!DOCTYPE html>
<html lang="zh" class="futuristic-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äººæœºå¯¹è¯ | SYNCTALK AI</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">

    <!-- JavaScriptæ¨¡å— -->
    <script src="{{ url_for('static', filename='js/modules/audio-manager.js') }}"></script>
    
    <style>
        .chat-container {
            min-height: 100vh;
            padding: var(--space-4);
        }
        
        .chat-header {
            margin-bottom: var(--space-6);
            text-align: center;
        }
        
        .chat-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #00c6ff, #7e57c2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-2);
        }
        
        .chat-subtitle {
            color: var(--text-secondary);
            font-size: 1.125rem;
        }
        
        .chat-main-grid {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: var(--space-4);
            height: calc(100vh - 200px);
        }
        
        @media (max-width: 1200px) {
            .chat-main-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .chat-main-grid {
                grid-template-columns: 1fr;
                height: auto;
            }
        }
        
        .voice-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        
        .voice-recorder {
            flex: 1;
            background: var(--surface-primary);
            border: 1px solid rgba(0, 198, 255, 0.3);
            border-radius: 16px;
            padding: var(--space-4);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .voice-waveform {
            width: 100%;
            height: 100px;
            margin-bottom: var(--space-4);
            position: relative;
        }
        
        .waveform-canvas {
            width: 100%;
            height: 100%;
        }
        
        .voice-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-3);
        }
        
        .record-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6bcb, #7e57c2);
            border: none;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .record-btn.recording {
            animation: pulse-glow 1s infinite alternate;
            background: linear-gradient(135deg, #00d4aa, #00c6ff);
        }
        
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 20px #00d4aa; }
            100% { box-shadow: 0 0 40px #00c6ff; }
        }
        
        .record-btn::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6bcb, #7e57c2, #00c6ff);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .record-btn:hover::before {
            opacity: 1;
        }
        
        .record-status {
            margin-top: var(--space-2);
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .chat-display {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        
        .chat-video {
            flex: 1;
            background: var(--surface-primary);
            border: 1px solid rgba(0, 198, 255, 0.3);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
        }
        
        .video-player {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            padding: var(--space-4);
            color: white;
        }
        
        .chat-messages {
            background: var(--surface-primary);
            border: 1px solid rgba(0, 198, 255, 0.3);
            border-radius: 16px;
            padding: var(--space-4);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .message-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        
        .message {
            padding: var(--space-3);
            border-radius: 8px;
            max-width: 80%;
        }
        
        .message.user {
            align-self: flex-end;
            background: rgba(0, 243, 255, 0.1);
            border-left: 3px solid #00c6ff;
        }
        
        .message.ai {
            align-self: flex-start;
            background: rgba(185, 103, 255, 0.1);
            border-left: 3px solid #7e57c2;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: var(--space-1);
        }
        
        .config-section {
            background: var(--surface-primary);
            border: 1px solid rgba(0, 198, 255, 0.3);
            border-radius: 16px;
            padding: var(--space-4);
            overflow-y: auto;
        }
        
        .config-group {
            margin-bottom: var(--space-4);
        }
        
        .config-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: var(--space-3);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .config-items {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        
        .config-item {
            background: var(--surface-secondary);
            border-radius: 8px;
            padding: var(--space-3);
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        
        .config-item:hover {
            border-color: #00c6ff;
        }
        
        .config-label {
            display: block;
            margin-bottom: var(--space-1);
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .config-value {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .start-chat-btn {
            flex: 2;
            padding: var(--space-3);
            font-size: 1.125rem;
            margin-top: var(--space-4);
        }

        .button-row {
            display: flex;
            gap: var(--space-2);
            align-items: center;
            margin-top: var(--space-4);
        }

        .button-row .action-btn {
            flex: 1;
            padding: var(--space-3);
            font-size: 0.875rem;
        }
        
        .time-estimate {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-top: var(--space-2);
        }
        
        .data-indicator {
            background: rgba(0, 198, 255, 0.1);
            border-radius: 8px;
            padding: var(--space-2) var(--space-3);
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .indicator-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .indicator-value {
            font-weight: 600;
            color: #00c6ff;
        }
        
        .neon-btn {
            background: rgba(0, 198, 255, 0.1);
            border: 1px solid rgba(0, 198, 255, 0.3);
            color: #00c6ff;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .neon-btn:hover {
            background: rgba(0, 198, 255, 0.2);
            box-shadow: 0 0 10px rgba(0, 198, 255, 0.3);
        }
        
        .neon-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .neon-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .neon-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .neon-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .neon-slider {
            background-color: #00c6ff;
        }
        
        input:checked + .neon-slider:before {
            transform: translateX(26px);
        }
        
        .neon-input {
            background: rgba(0, 198, 255, 0.1);
            border: 1px solid rgba(0, 198, 255, 0.3);
            color: #00c6ff;
            padding: 8px 12px;
            border-radius: 8px;
            width: 100%;
        }
        
        .neon-progress {
            height: 6px;
            background: rgba(0, 198, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .neon-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00c6ff, #7e57c2);
            border-radius: 3px;
        }
        
          
        .floating-card {
            box-shadow: 0 8px 32px rgba(0, 198, 255, 0.1);
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="neon-navbar">
        <a href="/" class="nav-brand">
            <span>SYNCTALK</span>
        </a>
        <ul class="nav-menu">
            <li><a href="/model_training" class="nav-link">è®­ç»ƒæ¨¡å‹</a></li>
            <li><a href="/video_generation" class="nav-link">è§†é¢‘ç”Ÿæˆ</a></li>
            <li><a href="/audio_clone" class="nav-link">éŸ³é¢‘å…‹éš†</a></li>
            <li><a href="/chat_system" class="nav-link active">äººæœºå¯¹è¯</a></li>
        </ul>
    </nav>

    <div class="chat-container">
        <div class="chat-header">
            <h1 class="chat-title">æ™ºèƒ½å¯¹è¯ç³»ç»Ÿ</h1>
            <p class="chat-subtitle">å®æ—¶è¯­éŸ³äº¤äº’ä¸æ™ºèƒ½å“åº”</p>
        </div>
        
        <div class="chat-main-grid">
            <!-- è¯­éŸ³è¾“å…¥åŒºåŸŸ -->
            <div class="voice-section">
                <div class="voice-recorder floating-card">
                    <div class="voice-waveform">
                        <canvas class="waveform-canvas" id="waveform"></canvas>
                    </div>
                    
                    <div class="voice-controls">
                        <button class="record-btn" id="recordBtn">
                            <span id="recordIcon">éº¦å…‹é£</span>
                            <span id="recordText" style="margin-top: 4px;">å¼€å§‹å½•éŸ³</span>
                        </button>
                        
                        <div class="record-status" id="recordStatus">
                            å‡†å¤‡å½•éŸ³
                        </div>
                        
                        <div class="data-indicator">
                            <span class="indicator-label">å½•éŸ³æ—¶é•¿</span>
                            <span class="indicator-value" id="recordTimer">00:00</span>
                        </div>
                    </div>
                </div>
                
                <div class="config-item">
                    <div class="config-label">éŸ³é¢‘è´¨é‡</div>
                    <div class="neon-progress" style="height: 4px;">
                        <div class="neon-progress-bar" style="width: 85%"></div>
                    </div>
                </div>
            </div>
            
            <!-- å¯¹è¯å±•ç¤ºåŒºåŸŸ -->
            <div class="chat-display">
                <div class="chat-video floating-card">
                    <video class="video-player" id="chatVideo" poster="{{ url_for('static', filename='images/video-poster.jpg') }}">
                        <source id="videoSource" src="" type="video/mp4">
                    </video>
                    
                    <div class="video-overlay">
                        <div class="data-indicator" style="background: transparent; padding: 0;">
                            <span class="indicator-label">å½“å‰å¯¹è¯</span>
                            <span class="indicator-value">å®æ—¶ç”Ÿæˆä¸­...</span>
                        </div>
                    </div>
                    
                    <div class="video-controls" style="position: absolute; top: 12px; right: 12px; display: flex; gap: 8px;">
                        <button class="neon-btn" id="fullscreenBtn" style="padding: 4px 8px; font-size: 12px;">
                            å…¨å±
                        </button>
                        <button class="neon-btn" id="downloadBtn" style="padding: 4px 8px; font-size: 12px;">
                            ä¸‹è½½
                        </button>
                    </div>
                </div>
                
                <div class="chat-messages floating-card">
                    <h3 class="config-title" style="margin-top: 0;">
                        <span>å¯¹è¯è®°å½•</span>
                    </h3>
                    
                    <div class="message-list" id="messageList">
                        <div class="message ai">
                            <div class="config-value">ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œå¯ä»¥å’Œæˆ‘è¿›è¡Œè¯­éŸ³å¯¹è¯ã€‚</div>
                            <div class="message-time">åˆšåˆš</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- é…ç½®åŒºåŸŸ -->
            <div class="config-section floating-card">
                <div class="config-group">
                    <h3 class="config-title">
                        <span>æ¨¡å‹é…ç½®</span>
                    </h3>
                    <div class="config-items">
                        <div class="config-item">
                            <div class="config-label">æ¨¡å‹åç§°</div>
                            <select class="neon-input" id="modelSelect" style="width: 100%;">
                                <option value="SyncTalk" selected>SyncTalk</option>
                                <option value="ER_NeRF">ER_NeRF</option>
                            </select>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">æ¨¡å‹è·¯å¾„</div>
                            <input type="text" class="neon-input" value="/SyncTalk/modelwide" id="modelPath" style="width: 100%;">
                        </div>
                    </div>
                </div>
                
                <div class="config-group">
                    <h3 class="config-title">
                        <span>å‚æ•°è®¾ç½®</span>
                    </h3>
                    <div class="config-items">
                        <div class="config-item">
                            <div class="config-label">å…‹éš†éŸ³é¢‘ç¼–å·</div>
                            <select class="neon-input" name="ref_audio_id" id="voiceCloneSelect" style="width: 100%;">
                                <option value="">è¯·é€‰æ‹©å…‹éš†éŸ³é¢‘</option>
                                <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptä»åç«¯åŠ è½½ -->
                            </select>
                            <small style="color: var(--text-secondary); font-size: 0.875rem; margin-top: var(--space-1); display: block;">
                                é€‰æ‹©å·²å…‹éš†çš„éŸ³é¢‘ç¼–å·
                            </small>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">APIæ¥å£</div>
                            <select class="neon-input" id="apiSelect" style="width: 100%;">
                                <option value="glm-4-plus">GLM-4 Plus</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="claude">Claude</option>
                            </select>
                        </div>
                        
                        <div class="config-item">
                            <div class="config-label">å“åº”é€Ÿåº¦</div>
                            <div class="neon-progress">
                                <div class="neon-progress-bar" style="width: 70%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="config-group">
                    <h3 class="config-title">
                        <span>ğŸ“Š ç³»ç»ŸçŠ¶æ€</span>
                    </h3>
                    <div class="config-items">
                        <div class="config-item">
                            <div class="config-label">CPUä½¿ç”¨ç‡</div>
                            <div class="config-value" id="cpuUsage">24%</div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">å†…å­˜ä½¿ç”¨</div>
                            <div class="config-value" id="memoryUsage">3.2/8 GB</div>
                        </div>
                        <div class="config-item">
                            <div class="config-label">ç½‘ç»œå»¶è¿Ÿ</div>
                            <div class="config-value" id="networkLatency">42 ms</div>
                        </div>
                    </div>
                </div>
                
                <div class="button-row">
                    <button class="neon-btn neon-btn-glow start-chat-btn" id="startChatBtn">
                        å¼€å§‹å¯¹è¯
                    </button>

                    <button class="neon-btn action-btn" id="refreshBtn">
                        åˆ·æ–°éŸ³é¢‘åˆ—è¡¨
                    </button>
                </div>

                <div class="time-estimate">
                    é¢„è®¡ç”Ÿæˆæ—¶é—´ï¼š10-30ç§’
                </div>
            </div>
        </div>
    </div>

    <script>
        // è·å–DOMå…ƒç´ 
        const recordBtn = document.getElementById('recordBtn');
        const recordIcon = document.getElementById('recordIcon');
        const recordText = document.getElementById('recordText');
        const recordStatus = document.getElementById('recordStatus');
        const recordTimer = document.getElementById('recordTimer');
        const waveformCanvas = document.getElementById('waveform');
        const ctx = waveformCanvas.getContext('2d');
        const startChatBtn = document.getElementById('startChatBtn');
        const chatVideo = document.getElementById('chatVideo');
        const messageList = document.getElementById('messageList');
        
        // çŠ¶æ€å˜é‡
        let isRecording = false;
        let recordingTime = 0;
        let timerInterval;
        let mediaRecorder = null;
        let audioChunks = [];
        
        // åˆå§‹åŒ–æ³¢å½¢å›¾
        function initWaveform() {
            waveformCanvas.width = waveformCanvas.offsetWidth;
            waveformCanvas.height = waveformCanvas.offsetHeight;
            drawWaveform(false);
        }
        
        // ç»˜åˆ¶æ³¢å½¢å›¾
        function drawWaveform(animate) {
            if (!ctx) return;
            
            ctx.clearRect(0, 0, waveformCanvas.width, waveformCanvas.height);
            
            const width = waveformCanvas.width;
            const height = waveformCanvas.height;
            const centerY = height / 2;
            
            if (animate && isRecording) {
                // åŠ¨æ€æ³¢å½¢
                ctx.strokeStyle = '#00c6ff';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                for (let x = 0; x < width; x++) {
                    const amplitude = Math.sin(x * 0.05 + Date.now() * 0.01) * 
                                     Math.sin(x * 0.03) * 20;
                    ctx.lineTo(x, centerY + amplitude);
                }
                
                ctx.stroke();
                requestAnimationFrame(() => drawWaveform(true));
            } else {
                // é™æ€æ³¢å½¢
                ctx.strokeStyle = 'rgba(0, 198, 255, 0.3)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                
                for (let x = 0; x < width; x++) {
                    const amplitude = Math.sin(x * 0.02) * 10;
                    ctx.lineTo(x, centerY + amplitude);
                }
                
                ctx.stroke();
            }
        }
        
        // æ›´æ–°å½•éŸ³è®¡æ—¶å™¨
        function updateTimer() {
            recordingTime++;
            const minutes = Math.floor(recordingTime / 60);
            const seconds = recordingTime % 60;
            recordTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // å¼€å§‹å½•éŸ³
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await uploadAudio(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                isRecording = true;
                recordBtn.classList.add('recording');
                recordIcon.textContent = 'åœæ­¢';
                recordText.textContent = 'åœæ­¢å½•éŸ³';
                recordStatus.textContent = 'å½•éŸ³ä¸­...';
                recordStatus.style.color = '#00d4aa';
                
                // å¼€å§‹è®¡æ—¶
                recordingTime = 0;
                timerInterval = setInterval(updateTimer, 1000);
                
                // å¼€å§‹ç»˜åˆ¶åŠ¨æ€æ³¢å½¢
                drawWaveform(true);
                
            } catch (error) {
                console.error('å½•éŸ³å¤±è´¥:', error);
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                stopRecording();
            }
        }
        
        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                clearInterval(timerInterval);
                
                recordBtn.classList.remove('recording');
                recordIcon.textContent = 'éº¦å…‹é£';
                recordText.textContent = 'å¼€å§‹å½•éŸ³';
                recordStatus.textContent = 'å¤„ç†ä¸­...';
                recordStatus.style.color = '#00c6ff';
                
                // åœæ­¢åŠ¨æ€æ³¢å½¢
                drawWaveform(false);
            }
        }
        
        // ä¸Šä¼ éŸ³é¢‘åˆ°æœåŠ¡å™¨
        async function uploadAudio(audioBlob) {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'input.wav');
            
            try {
                const response = await fetch('/save_audio', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    recordStatus.textContent = 'éŸ³é¢‘ä¸Šä¼ æˆåŠŸ';
                    
                    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                    addMessage('user', 'å·²ä¸Šä¼ è¯­éŸ³æ¶ˆæ¯');
                    
                    // å¼€å§‹ç”Ÿæˆè§†é¢‘
                    await generateVideo();
                } else {
                    recordStatus.textContent = 'ä¸Šä¼ å¤±è´¥: ' + result.message;
                    recordStatus.style.color = '#f44336';
                }
            } catch (error) {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                recordStatus.textContent = 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•';
                recordStatus.style.color = '#f44336';
            }
        }
        
        // ç”Ÿæˆè§†é¢‘
        async function generateVideo() {
            recordStatus.textContent = 'æ­£åœ¨ç”Ÿæˆè§†é¢‘...';
            
            const formData = new FormData();
            formData.append('model_name', 'SyncTalk');
            formData.append('model_param', '/SyncTalk/modelwide');
            formData.append('ref_audio_id', document.getElementById('voiceCloneSelect').value || '');
            formData.append('api_choice', document.getElementById('apiSelect').value);
            
            try {
                const response = await fetch('/chat_system', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    recordStatus.textContent = 'è§†é¢‘ç”ŸæˆæˆåŠŸ';
                    recordStatus.style.color = '#00d4aa';
                    
                    // æ›´æ–°è§†é¢‘æ’­æ”¾å™¨
                    if (result.video_path) {
                        chatVideo.src = result.video_path;
                        chatVideo.load();
                        chatVideo.play().catch(e => console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', e));
                    }
                    
                    // æ·»åŠ AIæ¶ˆæ¯
                    setTimeout(() => {
                        addMessage('ai', 'å·²ç”Ÿæˆå›åº”è§†é¢‘');
                    }, 1000);
                } else {
                    recordStatus.textContent = 'ç”Ÿæˆå¤±è´¥';
                    recordStatus.style.color = '#f44336';
                }
            } catch (error) {
                console.error('ç”Ÿæˆè§†é¢‘å¤±è´¥:', error);
                recordStatus.textContent = 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•';
                recordStatus.style.color = '#f44336';
            }
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯åˆ—è¡¨
        function addMessage(type, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            messageDiv.innerHTML = `
                <div class="config-value">${content}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            messageList.appendChild(messageDiv);
            messageList.scrollTop = messageList.scrollHeight;
        }
        
        // æ›´æ–°ç³»ç»ŸçŠ¶æ€
        function updateSystemStatus() {
            document.getElementById('cpuUsage').textContent = 
                `${Math.floor(Math.random() * 20 + 20)}%`;
            document.getElementById('memoryUsage').textContent = 
                `${(Math.random() * 1 + 3).toFixed(1)}/8 GB`;
            document.getElementById('networkLatency').textContent = 
                `${Math.floor(Math.random() * 30 + 30)} ms`;
        }
        
        // äº‹ä»¶ç›‘å¬å™¨
        recordBtn.addEventListener('click', function() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        });
        
        startChatBtn.addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'å¤„ç†ä¸­...';
            
            try {
                await generateVideo();
            } finally {
                setTimeout(() => {
                    this.disabled = false;
                    this.textContent = 'å¼€å§‹å¯¹è¯';
                }, 2000);
            }
        });
        
        document.getElementById('fullscreenBtn').addEventListener('click', function() {
            if (chatVideo.requestFullscreen) {
                chatVideo.requestFullscreen();
            } else if (chatVideo.webkitRequestFullscreen) {
                chatVideo.webkitRequestFullscreen();
            }
        });
        
        document.getElementById('downloadBtn').addEventListener('click', function() {
            if (chatVideo.src) {
                const a = document.createElement('a');
                a.href = chatVideo.src;
                a.download = 'chat_video.mp4';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                alert('è¯·å…ˆç”Ÿæˆè§†é¢‘');
            }
        });
        
        // åˆå§‹åŒ–éŸ³é¢‘é€‰æ‹©æ¡†
        async function initializeAudioSelects() {
            try {
                // åˆå§‹åŒ–è¯­éŸ³å…‹éš†é€‰æ‹©æ¡† - å¼ºåˆ¶åˆ·æ–°ä»¥è·å–æœ€æ–°æ•°æ®
                const voiceCloneSelect = document.getElementById('voiceCloneSelect');
                if (voiceCloneSelect) {
                    await window.AudioUtils.fillAudioSelect('#voiceCloneSelect', 'è¯·é€‰æ‹©å…‹éš†éŸ³é¢‘', '', true);
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–éŸ³é¢‘é€‰æ‹©æ¡†å¤±è´¥:', error);
            }
        }

        // å¼ºåˆ¶åˆ·æ–°éŸ³é¢‘æ•°æ®
        async function refreshAudioData() {
            try {
                console.log('æ­£åœ¨åˆ·æ–°éŸ³é¢‘æ•°æ®...');
                await window.AudioUtils.refreshAllAudioSelects();
                console.log('éŸ³é¢‘æ•°æ®åˆ·æ–°å®Œæˆ');

                // æ˜¾ç¤ºåˆ·æ–°æˆåŠŸæç¤º
                const btn = document.getElementById('refreshBtn');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'âœ… å·²åˆ·æ–°';
                    btn.style.color = 'var(--neon-green)';

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.color = '';
                    }, 2000);
                }
            } catch (error) {
                console.error('åˆ·æ–°éŸ³é¢‘æ•°æ®å¤±è´¥:', error);

                // æ˜¾ç¤ºåˆ·æ–°å¤±è´¥æç¤º
                const btn = document.getElementById('refreshBtn');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = 'âŒ åˆ·æ–°å¤±è´¥';
                    btn.style.color = 'var(--neon-red)';

                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.color = '';
                    }, 2000);
                }
            }
        }

        // åˆ·æ–°æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('refreshBtn').addEventListener('click', refreshAudioData);

        // åˆå§‹åŒ–
        window.addEventListener('load', () => {
            initWaveform();
            initializeAudioSelects();
            setInterval(updateSystemStatus, 5000);
            updateSystemStatus();
        });

        // å“åº”å¼è°ƒæ•´æ³¢å½¢å›¾å¤§å°
        window.addEventListener('resize', initWaveform);
    </script>
</body>
</html>